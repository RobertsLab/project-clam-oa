---
title: "03.00-D-sRNAseq-gene-expression-DESeq2"
author: "Sam White"
date: "2025-01-31"
output: 
  bookdown::html_document2:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
  github_document:
    toc: true
    number_sections: true
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
    code_download: true
bibliography: references.bib
---

# Background


```{r setup, include=FALSE}
library("RColorBrewer")
library("DESeq2")
library("ggplot2")
library("knitr")
library("pheatmap")
library("tidyverse")
knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = FALSE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = ""         # Prevents appending '##' to beginning of lines in code output
)
```


# Set R variables
```{r set-variables}
# Define the output directory path
output_dir <- "../output/03.00-D-sRNAseq-gene-expression-DESeq2/"

# Set desired false discovery rate threshold (i.e. adjusted p-value, padj)
fdr <- 0.05

# Set log2 fold change threshold (a value of '1' is equal to a fold change of '2')
log2fc <- 1
```

# Load count data

Load in the sRNA count matrix generated using ShortStack 4.1.1. Keep in mind this data includes counts of all sRNAs, not just miRNAs.

Counts generated in `02.00-ShortStack-31bp-fastp-merged`.

## Select only miRNAs IDd by ShortStack

```{r load-sRNA-counts}
# Read in sRNA counts data
srna_seq_counts_shortstack <- read_delim("../output/02.00-ShortStack-31bp-fastp-merged/ShortStack_out/Counts.txt", delim="\t")

srna_seq_counts_shortstack <- srna_seq_counts_shortstack %>% filter(MIRNA == "Y")

str(srna_seq_counts_shortstack)

```

# Create DESeq2 Column Data

## Read in metdata CSV
```{r read-metadata, eval=TRUE}
# Load metadata
metadata <- read.csv("../data/ManilaOA2023_shortRNASeq_Meta.csv", header = TRUE)

str(metadata)
```

## Extract sample names
```{r extract-sample-names, eval=TRUE}
sample_names <- colnames(srna_seq_counts_shortstack) %>%
  str_subset("^\\d+-") %>%
  str_extract("^\\d+")

str(sample_names)
```

## Select sample namd and treatment
```{r filter-metadata, eval=TRUE}
sample_treatment_df <- metadata %>%
  select(ID_simple, treatment)

# Set sample names as rownames
rownames(sample_treatment_df) <- sample_treatment_df$ID_simple

sample_treatment_df$ID_simple <- NULL

str(sample_treatment_df)
```


## Write DEseq coldata to file
```{r write-deseq-coldata, eval=TRUE}
write.table(
  sample_treatment_df,
  file = "../output/03.00-D-sRNAseq-gene-expression-DESeq2/DESeq2-coldata.tab",
  sep = "\t",
  quote = FALSE,
  col.names = NA
)

```


# Count data munging

## Fix col names and convert to matrix
```{r sRNA-count-data-munging}
coldata <- sample_treatment_df

# Remove excess portions of sample column names to just "sample###"
colnames(srna_seq_counts) <- sub("-fastp-adapters-polyG-31bp-merged_condensed", "", colnames(srna_seq_counts))

# Keep just the counts and cluster names as matrix
srna_seq_counts_matrix <- as.matrix(srna_seq_counts %>% select(-Coords, -MIRNA) %>% column_to_rownames(var = "Name"))

str(srna_seq_counts_matrix)
```

## Take only samples present in coldata
```{r, eval=TRUE}

common_cols <- intersect(colnames(srna_seq_counts_matrix),
                         rownames(sample_treatment_df))

srna_seq_counts_matrix <- srna_seq_counts_matrix[, common_cols]

str(srna_seq_counts_matrix)
```

## Reorder matrix cols to match coldata
```{r reorder-matrix-cols, eval=TRUE}
ord <- match(rownames(sample_treatment_df), colnames(srna_seq_counts_matrix))

srna_seq_counts_matrix_sorted <- srna_seq_counts_matrix[, ord]

```

## Verify rownames match
```{r check-rownames, eval=TRUE}
all(rownames(coldata) == colnames(srna_seq_counts_matrix_sorted))
```

# Create DESeq2 data set

## Initialize DEseq2 data set
```{r create-deseq2-data-set, eval=TRUE}
dds <- DESeqDataSetFromMatrix(countData = srna_seq_counts_matrix_sorted,
                              colData = coldata,
                              design = ~ treatment)
dds

```

## Add cluster columun as "gene" feature
```{r add-cluaster-as-gene-feature, eval=TRUE}
featureData <- data.frame(gene=rownames(srna_seq_counts_matrix_sorted))
mcols(dds) <- DataFrame(mcols(dds), featureData)
mcols(dds)
```
## Set factor levels
```{r set-factor-levels, eval=TRUE}
dds$treatment <- factor(dds$treatment, levels = c("control", "treatment"))
```

# DESeq analysis

## DEseq
```{r deseq, eval=TRUE}
dds <- DESeq(dds)
```

## DEseq Results
```{r assign-results, eval=TRUE}

res <- results(dds, alpha = fdr, lfcThreshold = log2fc)

res

summary(res)

table(res$padj < fdr)
```
## Write DDS results tables to CSVs
```{r write-dds-results-table, eval=TRUE}
write.csv(res, file = paste0(output_dir, "deseq2", ".table.csv"), row.names = TRUE, quote = FALSE)
```

# Variance stabilizing transformations (VST)
- Here we transform counts using a variance stabilizing transformation (VST), since we have many samples. 
```{r VST, eval=TRUE}
vsd <- varianceStabilizingTransformation(dds, blind=FALSE)
```

# Plotting

## Sample distances
```{r plot-sample-distances}
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix( sampleDists )

rownames(sampleDistMatrix) <- paste( vsd$colony.id, vsd$time.point, sep = " - " )

colnames(sampleDistMatrix) <- NULL

colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)
```

## PCA
Visualize sample clustering via PCA (after transformation)
```{r pca, eval=TRUE}
# PCA with points color coded by time point 
plotPCA(vsd, intgroup = c("treatment"))
```

## Heatmap top 20
```{r heatmap}
top20_counts <- order(rowMeans(counts(dds,normalized=TRUE)),
                decreasing=TRUE)[1:20]

annotation = colData(dds) %>% as.data.frame() %>% select(treatment)

pheatmap(assay(vsd)[top20_counts,], 
         cluster_rows=FALSE, 
         show_rownames=TRUE,
         cluster_cols=TRUE, 
         annotation_col = annotation)

```
